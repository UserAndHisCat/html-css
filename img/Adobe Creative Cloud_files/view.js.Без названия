define(["plugin-dependencies","jquery","underscore","backbone","require","utils","plugin-components/data-store","common/auth/user","text!./view.html","text!./info.html"],function(e,t,o,i,a,n,s,l,d,r){var c=e.utils.template.createTemplate(d),u=e.utils.template.createTemplate(r),p={},m=["type","created","modified","size","width","height","shared"],h=e.log();return i.View.extend({className:"control-container",initialize:function(){o.bindAll(this,"getAsset","addShortUrl","handleShareButtonClick","updateShareButtonUi","updateCollaborationUi","parseInfo","handleReportAbuse","analyticsAcessPrivacy")},render:function(){var t=this;return this.$el.find(".made-with-container").show(),this.getAsset().then(function(o){t.$el.html(c({translate:e.translate}));var i=t.parseInfo();t.$el.find("ul").append(u({translate:e.translate,value:i}));var s=t.model.get("type");("application/vnd.adobe.sparkler.project+dcx"===s||n.hasFeature("ccweb_dimension_dcx")&&"3d/vnd.adobe.dn+dcx"===s)&&(t.$el.find(".size").prev().addBack().remove(),t.$el.find(".access").prev().addBack().remove()),t.$(".report-abuse-container button").click(t.handleReportAbuse),t.$(".access button").click(t.handleShareButtonClick),t.model.set("shared",""),a(["files/dialogs/send-link/api"],function(e){e.validateAssetPermissions(o).then(function(){return e.getResourceLinks(o)}).then(function(e){e&&e.id?(t.linkId=e.id,t.model.set("shared",!0)):t.model.set("shared",!1),t.$el.find(".access button").css("visibility","visible"),t.analyticsAcessPrivacy()})});var l=t.$el.find("#made-with"),d=t.model.get("colors"),r=t.model.get("app"),p=t.model.get("fonts"),m=t.model&&t.model.attributes&&t.model.attributes.collection_data&&t.model.attributes.collection_data.composite_content_type&&"application/vnd.adobe.sparkler.project+dcx"===t.model.attributes.collection_data.composite_content_type,f=n.hasFeature("ccweb_dimension_dcx")&&t.model&&t.model.attributes&&t.model.attributes.collection_data&&t.model.attributes.collection_data.composite_content_type&&"3d/vnd.adobe.dn+dcx"===t.model.attributes.collection_data.composite_content_type;l.empty(),d&&a(["./media-info/colors"],function(e){l.append(e.setResource(d).render().$el),e.$el.on("click",function(){h("ets",{code:"CC_FILE_ACTIVITY",sub_code:"KULER"})})}),r&&a(["./media-info/app"],function(e){l.append(e.setResource(r).render().$el)}),p&&a(["./media-info/fonts"],function(e){l.append(e.setResource(p).render().$el)}),m&&a(["./media-info/xd"],function(e){l.append(e.setResource(t.model.attributes.collection_data.composite_content_type).render().$el)}),f&&a(["./media-info/dn"],function(e){l.append(e.setResource(t.model.attributes.collection_data.composite_content_type).render().$el)}),d||r||p||m||f||t.$el.find(".made-with-container").hide(),t.updateShareButtonUi(),t.model.on("change:shared",t.updateShareButtonUi),t.updateCollaborationUi(),t.model.on("change:_collaboratorCount",t.updateCollaborationUi)}),this},analyticsAcessPrivacy:function(){var e=t(".access button").text();h("cca",{root:{access:e,assetid:this.model.get("id")}})},getAsset:function(){var e=this,o=t.Deferred(),i=this.model&&this.model.attributes&&this.model.attributes.collection_data&&this.model.attributes.collection_data.composite_content_type,a=s.asset(this.model.get("id")).colors||s.asset(this.model.get("id")).app||s.asset(this.model.get("id")).fonts;return a||i?o.resolve(s.asset(this.model.get("id"))):s.refreshAsset(this.model.get("id"),function(t){p=t.updatedAttributes?t.updatedAttributes:e.model.toJSON(),o.resolve(p)}),o},setModel:function(e){this.model=e},addShortUrl:function(){var o=this.model.get("publicURL");if(o)t(".public-url").html(' <a href="'+o+'" target="_blank">'+o+"</a>");else{var i=this.linkId;e.utils.getShortPublicShareUrl(i).then(function(e){t(".public-url").html(' <a href="'+e+'" target="_blank">'+e+"</a>")})}},handleShareButtonClick:function(){h("cca",{code:"Send Link",root:{assetType:"File",assetid:this.model.get("id"),dropDown:"Access"}});var t=this;e.utils.hasFeature("files_new_send_link_dialog")?a(["files/dialogs/new-send-link/dialog"],function(i){var a=t.model.toJSON(),n=!0;e.utils.hasFeature("temp_collab_acl_folders")?s.getCollaboration(a._mountTarget||a.location).then(function(e){o.each(e.collaborators,function(e){l.get("userId")===e.userId&&"viewer"===e.role&&(n=!1)});var s=o.extend(a,{isWritable:n});i.setItem(s).show().on("link.created",function(e,o){t.model.set("publicURL",o.publicURL),t.model.set("shared",!0)}).on("link.deleted",function(){t.model.set("shared",!1)})}):i.setItem(a).show().on("link.created",function(e,o){t.model.set("publicURL",o.publicURL),t.model.set("shared",!0)}).on("link.deleted",function(){t.model.set("shared",!1)})}):a(["files/dialogs/send-link/dialog"],function(e){e.setItem(t.model.toJSON()).show().on("link.created",function(e,o){e.stopPropagation(),t.linkId=o.id,t.model.set("shared",!0)}).on("link.deleted",function(e){e.stopPropagation(),t.linkId=!1,t.model.set("shared",!1)})})},updateCollaborationUi:function(){var e=this.model.get("_collaboratorCount");0===e?this.$(".report-abuse-container").hide():this.$(".report-abuse-container").show()},updateShareButtonUi:function(){var t=this.$el.find(".access"),o=this.$el.find(".access button"),i=this.$el.find(".public-url"),a='<em class="sprite30x30"></em>';this.model.get("shared")?(t.removeClass("private").addClass("public"),o.html(a+e.translate("Public")),this.addShortUrl()):(t.removeClass("public").addClass("private"),o.html(a+e.translate("Private")),i.empty())},parseInfo:function(){for(var t={},i=0;i<m.length;i++){var a=m[i],n=this.model.get(a);if("type"===a&&(n=o.isUndefined(e.mimetypes.files[n])?o.last(n.split("/")):e.mimetypes.files[n]),("created"===a||"modified"===a)&&(n=e.utils.formatDate(new Date(n))),"size"===a&&(n=e.utils.translateBytes(n)),("width"===a||"height"===a)&&(n=e.translate("{0}px",n)),"shared"===a){var s=e.translate(n?"Public":"Private");n='<button type="button"><em class="sprite30x30"></em>'+s+'</button><span class="public-url"></span>'}t[a]=n}return t},handleReportAbuse:function(){var e=this.model;a(["files/dialogs/report-abuse/dialog"],function(t){t.setFile(e).show()})}})});