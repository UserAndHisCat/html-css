define(["plugin-dependencies","jquery","underscore","backbone","external/comments-sdk/comments","plugin-components/data-store","common/datastore/collabservice/api/comments/read","common/utils/sharedcloud"],function(e,t,n,r,o,s,a,i){var c=o.Annotation,d=o.Client,l=o.Asset,u=r.Collection.extend({initialize:function(){n.bindAll(this,"fetchActivityStream","collapseVersions","createRedhawkComment","deleteRedhawkComment"),this.on("add",function(e){"undefined"!=typeof e.get("revision_number")?e.set("type","version"):e.set("type","comment")}),e.stellarConfig.get("features.comments_redhawk")&&(d.instance.configure({environment:e.stellarConfig.get("ENVIRONMENT"),token:"Bearer "+e.user.get("token")}),e.events.on("comments.redhawk.delete:start",this.deleteRedhawkComment)),this.commentsErrorCount=0},comparator:function(e,t){return e.get("created")!==t.get("created")?e.get("created")>t.get("created")?-1:1:void 0},createRedhawkComment:function(e){var n=t.Deferred();return this.currentRedhawkAsset.comment(e,null,null).then(n.resolve),n.promise()},deleteRedhawkComment:function(t){var r=(t.id,{id:t.id,created:t.get("created"),target:{source:t.get("_target")}}),o=n.last(this.assetModel.get("id").split("/")),s=new c(o,r);s.get(d).then(function(t){s.annotationObject.etag=t.etag,s.delete(d).then(function(){e.events.trigger("comments.redhawk.delete:success")})})},fetchActivityStream:function(r){this.reset();var o=this,c=[],u=[],m=t.Deferred(),h=this.assetModel.get("id"),f=function(){var e=t.Deferred(),n=s.asset(h).revisions;return n&&!r?e.resolve(s.asset(h).revisions):s.refreshAsset(h,function(t){t.updatedAttributes&&e.resolve(t.updatedAttributes.revisions)}),e},g=function(){var r=t.Deferred();if(e.stellarConfig.get("features.comments_redhawk")){var s=e.user.get("token"),c=o.assetModel.get("id"),u=i.sharedCloudIDFromLocation(c).region,m="urn:aaid:ccx:"+u+":"+n.last(o.assetModel.get("id").split("/"));o.currentRedhawkAsset=new l(m),o.currentRedhawkAsset.get().then(function(e){var t=e.annotations;r.resolve(t)}).catch(function(){p(m,s).then(function(){d.instance.configure({disableGetAuthorization:"true"}),o.commentsErrorCount++,o.commentsErrorCount<5?o.fetchActivityStream():r.reject()})})}else a(h).done(function(e){r.resolve(e)});return r},p=function(r,s){{var a=new t.Deferred;n.last(o.assetModel.get("id").split("/"))}return t.ajax({type:"PUT",url:e.stellarConfig.get("redhawk_comments_uri")+"/assets/"+r+"/annots/acl",headers:{"Content-Type":'application/vnd.adobe.dc+json;profile="https://comments.acrobat.com/schemas/acl_v1.json"',Authorization:"Bearer "+s},data:JSON.stringify([{principalType:"allUsers",role:"annotationViewer"},{principalType:"allAuthenticatedUsers",role:"annotationContributor"}]),timeout:2e4}).then(a.resolve).fail(a.reject),a.promise()};return f().then(function(e){c=e||[]}).then(g).then(function(t){u=t||[],u=e.stellarConfig.get("features.comments_redhawk")?o.parseRedhawkComments(t):t||[]}).always(function(){o.add(c.concat(u)),m.resolve(o.collapseVersions(o.models))}),m},parseRedhawkComments:function(e){return n.map(e,function(e){return{avatar:e.creator.img,commenter_name:e.creator.name,commenter_email:e.creator.email,content:e.bodyValue,url:e.annotationId,_target:e.target.source,created:Date.parse(e.created),id:e.id}})},collapseVersions:function(t){for(var n=[],r=[],o=300;t.length>0;){var s=t.shift(),a=t[0],i=s.get("isVersionHead");"version"!==s.get("type")||i?(n.length>0&&(r.push(n),n=[]),r.push(s)):a&&"version"===a.get("type")&&!a.get("isVersionHead")&&e.utils.convertDiffUtToSeconds(a.get("created"))-e.utils.convertDiffUtToSeconds(s.get("created"))<o?n.push(s):0===n.length?r.push(s):(n.push(s),r.push(n),n=[])}return r}});return u});