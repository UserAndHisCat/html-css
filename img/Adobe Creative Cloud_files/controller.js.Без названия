define(["jquery","underscore","plugin-dependencies","./view","./activity-collection","./comment-model","plugin-components/data-store","common/datastore/collabservice/api/comments/create","common/utils/sharedcloud"],function(e,t,n,o,m,a,i,r){var l,c=n.log("ccweb.files.activity"),d=new o,s=new m,u=n.utils.getPageName(),f="share"===u||-1!==u.indexOf("share"),h=function(e,t){if(""===e.comment)return void d.displayError("comment");if(e.comment&&e.comment.length>1e3)return c("comment-error-max-char"),void d.displayMaxCharError(e.comment.length);if(t)e.name=n.user.get("displayName"),e.email=n.user.get("email");else{if(""===e.name)return void d.displayError("name");var o=e.email.length>0?n.utils.getValidEmails(e.email):[];if(0===o.length)return void d.displayError("email")}g(e)},g=function(e){var t="application/vnd.adobe.asset";return d.disableComments(),n.stellarConfig.get("features.comments_redhawk")?s.createRedhawkComment(e.comment).then(function(e){var t=new a;t.set({url:e.id,_target:e.target.source,commenter_name:n.utils.htmlEncode(e.creator.name),commenter_email:n.utils.htmlEncode(e.creator.email),content:n.utils.htmlEncode(e.bodyValue),id:e.id,created:(new Date).getTime()}),s.add(t),d.handleNewComment(t)}).fail(function(){d.handleCommentError()}).always(function(){d.enableComments()}):r(l.id,t,e.name,e.email,e.comment,null).done(function(t,o,m){var i=m.getResponseHeader("Location"),r=new a;r.set({url:i,_target:l.id,commenter_name:n.utils.htmlEncode(e.name),commenter_email:n.utils.htmlEncode(e.email),content:n.utils.htmlEncode(e.comment),id:i.split("/").pop(),created:(new Date).getTime()}),s.add(r),d.handleNewComment(r)}).fail(function(){d.handleCommentError()}).always(function(){d.enableComments()}),c("add-comment"),c("ets",{code:"CC_COLLABORATION_ACTIVITY",sub_code:"COMMENT"}),c("cca",{code:"Comments",root:{assetid:l.id,assetType:"File",viewType:"1Up"}}),!1},p={setResource:function(e){return l=e,d.model=l,d.collection=s,s.assetModel=e,p},show:function(){return d.isLoggedIn="undefined"!=typeof n.auth.token,d.displayRevisions=!f&&l.get("revisions"),d.on("comment.validate-form",h),d.render().$el},remove:function(){return d.off("comment.validate-form",h),d.remove(),p}};return p});